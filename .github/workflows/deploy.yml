name: Multi-Branch CI/CD Pipeline

on:
  push:
    branches: [main, dev, release]
  pull_request:
    branches: [main, dev, release]

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ (æ‰€æœ‰åˆ†æ”¯éƒ½è¿è¡Œ)
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check
        continue-on-error: false

      - name: Lint check
        run: npm run lint
        continue-on-error: false

      - name: Build check
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

  # éƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒ
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'push'
    strategy:
      matrix:
        include:
          - branch: main
            environment: production
            url_suffix: ''
          - branch: release
            environment: staging
            url_suffix: '-staging'
          - branch: dev
            environment: development
            url_suffix: '-dev'
    
    # åªåœ¨å¯¹åº”åˆ†æ”¯æ¨é€æ—¶è¿è¡Œ
    if: github.ref == format('refs/heads/{0}', matrix.branch)
    
    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          # æ ¹æ®ç¯å¢ƒè®¾ç½®ä¸åŒçš„ç¯å¢ƒå˜é‡
          NEXT_PUBLIC_ENV: ${{ matrix.environment }}
          NEXT_PUBLIC_API_URL: ${{ secrets[format('API_URL_{0}', matrix.environment)] }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets[format('SUPABASE_URL_{0}', matrix.environment)] }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets[format('SUPABASE_ANON_KEY_{0}', matrix.environment)] }}

      # Vercel éƒ¨ç½² (æ¨èç”¨äº Next.js)
      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          # æ ¹æ®åˆ†æ”¯è®¾ç½®ä¸åŒçš„éƒ¨ç½²é…ç½®
          vercel-args: >-
            ${{ matrix.branch == 'main' && '--prod' || 
                format('--target preview --meta branch={0}', matrix.branch) }}

      # æˆ–è€…ä½¿ç”¨ Netlify éƒ¨ç½²
      # - name: Deploy to Netlify
      #   id: deploy
      #   uses: nwtgck/actions-netlify@v2.0
      #   with:
      #     publish-dir: './.next'
      #     production-branch: ${{ matrix.branch == 'main' }}
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deploy-message: "Deploy from GitHub Actions"
      #     enable-pull-request-comment: true
      #     enable-commit-comment: true
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets[format('NETLIFY_SITE_ID_{0}', matrix.environment)] }}

      - name: Comment deployment info
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ matrix.environment }}';
            const deployUrl = '${{ steps.deploy.outputs.preview-url || steps.deploy.outputs.url }}';
            const branch = '${{ matrix.branch }}';
            
            // åˆ›å»ºéƒ¨ç½²çŠ¶æ€è¯„è®º
            const comment = `
            ## ğŸš€ éƒ¨ç½²æˆåŠŸï¼
            
            **åˆ†æ”¯:** \`${branch}\`
            **ç¯å¢ƒ:** \`${environment}\`
            **éƒ¨ç½²åœ°å€:** ${deployUrl}
            
            ### ç¯å¢ƒè¯´æ˜:
            ${environment === 'production' ? 'ğŸŒŸ **ç”Ÿäº§ç¯å¢ƒ** - ç”¨æˆ·æ­£å¼ä½¿ç”¨çš„ç‰ˆæœ¬' : ''}
            ${environment === 'staging' ? 'ğŸ§ª **é¢„å‘å¸ƒç¯å¢ƒ** - å‘å¸ƒå‰çš„æœ€ç»ˆæµ‹è¯•ç‰ˆæœ¬' : ''}
            ${environment === 'development' ? 'ğŸ”§ **å¼€å‘ç¯å¢ƒ** - å¼€å‘å’Œæµ‹è¯•ä½¿ç”¨çš„ç‰ˆæœ¬' : ''}
            `;
            
            // å¦‚æœæœ‰ç›¸å…³çš„ issue æˆ– PRï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä¿¡æ¯
            console.log(comment);

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [quality-check, deploy]
    if: always() && github.event_name == 'push'
    steps:
      - name: Notify Success
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ç¯å¢ƒ: ${{ github.ref_name == 'main' && 'production' || github.ref_name == 'release' && 'staging' || 'development' }}"

      - name: Notify Failure
        if: needs.deploy.result == 'failure' || needs.quality-check.result == 'failure'
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚" 