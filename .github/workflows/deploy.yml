name: Multi-Branch CI/CD Pipeline (dev/release/main)

on:
  push:
    branches: [main, dev, release]
  pull_request:
    branches: [main, dev, release]

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ (æ‰€æœ‰åˆ†æ”¯éƒ½è¿è¡Œ)
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check
        continue-on-error: false

      - name: Lint check
        run: npm run lint
        continue-on-error: false

      - name: Build check
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

  # éƒ¨ç½²åˆ°å¯¹åº”ç¯å¢ƒ
  deploy:
    name: Deploy to ${{ github.ref_name }} Environment
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'push'
    
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || github.ref_name == 'release' && 'staging' || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set Environment Variables
        run: |
          echo "Setting environment variables for ${{ github.ref_name }} branch"
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "ENV_TYPE=production" >> $GITHUB_ENV
            echo "ENV_NAME=MAIN" >> $GITHUB_ENV
            echo "DEPLOY_URL_SUFFIX=" >> $GITHUB_ENV
          elif [ "${{ github.ref_name }}" = "release" ]; then
            echo "ENV_TYPE=staging" >> $GITHUB_ENV
            echo "ENV_NAME=RELEASE" >> $GITHUB_ENV
            echo "DEPLOY_URL_SUFFIX=-release" >> $GITHUB_ENV
          else
            echo "ENV_TYPE=development" >> $GITHUB_ENV
            echo "ENV_NAME=DEV" >> $GITHUB_ENV
            echo "DEPLOY_URL_SUFFIX=-dev" >> $GITHUB_ENV
          fi

      - name: Build application
        run: npm run build
        env:
          # æ ¹æ®åˆ†æ”¯è®¾ç½®å¯¹åº”çš„ç¯å¢ƒå˜é‡
          NEXT_PUBLIC_ENV: ${{ env.ENV_TYPE }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets[format('NEXT_PUBLIC_SUPABASE_URL_{0}', env.ENV_NAME)] }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets[format('NEXT_PUBLIC_SUPABASE_ANON_KEY_{0}', env.ENV_NAME)] }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets[format('SUPABASE_SERVICE_ROLE_KEY_{0}', env.ENV_NAME)] }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets[format('NEXT_PUBLIC_SITE_URL_{0}', env.ENV_NAME)] }}

      # éƒ¨ç½²çŠ¶æ€æ˜¾ç¤º
      - name: Deploy Status
        run: |
          echo "ğŸš€ éƒ¨ç½²ä¿¡æ¯:"
          echo "   åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   ç¯å¢ƒ: ${{ env.ENV_TYPE }}"
          echo "   é…ç½®: ${{ env.ENV_NAME }}"
          echo "   æ„å»º: âœ… æˆåŠŸ"
          echo ""
          echo "ğŸŒ ç¯å¢ƒå¯¹åº”å…³ç³»:"
          echo "   â€¢ dev åˆ†æ”¯ â†’ å¼€å‘ç¯å¢ƒ (Development)"
          echo "   â€¢ release åˆ†æ”¯ â†’ é¢„å‘å¸ƒç¯å¢ƒ (Staging)"
          echo "   â€¢ main åˆ†æ”¯ â†’ ç”Ÿäº§ç¯å¢ƒ (Production)"

      # TODO: å®é™…éƒ¨ç½²åˆ° Vercel (é…ç½®å¥½ Secrets åå¯ç”¨)
      # - name: Deploy to Vercel
      #   uses: amondnet/vercel-action@v25
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      #     working-directory: ./
      #     vercel-args: ${{ github.ref_name == 'main' && '--prod' || '--target preview' }}

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [quality-check, deploy]
    if: always() && github.event_name == 'push'
    steps:
      - name: Notify Success
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… ${{ github.ref_name }} ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“Š éƒ¨ç½²è¯¦æƒ…:"
          echo "   åˆ†æ”¯: ${{ github.ref_name }}"
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "   ç¯å¢ƒ: ğŸŒŸ ç”Ÿäº§ç¯å¢ƒ (Production)"
            echo "   ç”¨é€”: æ­£å¼ç”¨æˆ·ä½¿ç”¨"
          elif [ "${{ github.ref_name }}" = "release" ]; then
            echo "   ç¯å¢ƒ: ğŸ§ª é¢„å‘å¸ƒç¯å¢ƒ (Staging)"
            echo "   ç”¨é€”: å‘å¸ƒå‰æœ€ç»ˆæµ‹è¯•"
          else
            echo "   ç¯å¢ƒ: ğŸ”§ å¼€å‘ç¯å¢ƒ (Development)"
            echo "   ç”¨é€”: åŠŸèƒ½å¼€å‘å’Œè°ƒè¯•"
          fi

      - name: Notify Failure
        if: needs.deploy.result == 'failure' || needs.quality-check.result == 'failure'
        run: |
          echo "âŒ ${{ github.ref_name }} ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚" 